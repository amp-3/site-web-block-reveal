var C=Object.defineProperty;var D=(s,a,e)=>a in s?C(s,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[a]=e;var l=(s,a,e)=>D(s,typeof a!="symbol"?a+"":a,e);import{B as M,S as g,R as p,M as f,a as w}from"./BaseInputHandler.js";class y extends M{constructor(e){super(e);l(this,"dragState");l(this,"config");l(this,"lastThrottleTime",0);l(this,"globalMoveHandler",null);l(this,"globalUpHandler",null);this.config={dragThreshold:1,swipeMinVelocity:100,throttleInterval:8},this.dragState={isDragging:!1,startX:0,startY:0,currentX:0,currentY:0,startTime:0,lastMoveTime:0}}setupEventListeners(){this.container.eventMode="static",this.container.interactiveChildren=!1,this.container.on("pointerdown",this.handlePointerDown.bind(this)),this.container.on("pointermove",this.handlePointerMove.bind(this)),this.container.on("pointerup",this.handlePointerUp.bind(this)),this.container.on("pointercancel",this.handlePointerCancel.bind(this)),this.container.on("touchstart",this.handleTouchStart.bind(this)),this.container.on("touchmove",this.handleTouchMove.bind(this)),this.container.on("touchend",this.handleTouchEnd.bind(this)),this.container.on("touchcancel",this.handleTouchCancel.bind(this))}onEnable(){const e=this.container.children;if(e.length>0&&e[0]instanceof g){const t=e[0];this.container.hitArea=new p(0,0,t.width,t.height)}else{const t=this.container.getLocalBounds();t.width>0&&t.height>0&&(this.container.hitArea=new p(t.x,t.y,t.width,t.height))}}onDisable(){}handlePointerDown(e){if(!this.isEnabled)return;const t=this.getNormalizedCoordinates(e);this.startDrag(t.x,t.y),this.onInput(t.x,t.y)}handleTouchStart(e){if(!this.isEnabled)return;e.preventDefault();const t=this.getNormalizedCoordinates(e);this.startDrag(t.x,t.y),this.onInput(t.x,t.y)}getNormalizedCoordinates(e){const t=this.container.children;if(t.length>0&&t[0]instanceof g){const i=t[0],r=e.getLocalPosition(i);return f.normalizeCoordinate(r.x,r.y,i.width,i.height)}const n=e.getLocalPosition(this.container),o=this.container.getLocalBounds();return o.width===0||o.height===0?{x:0,y:0}:f.normalizeCoordinate(n.x,n.y,o.width,o.height)}handlePointerMove(e){if(!this.isEnabled)return;const t=this.getNormalizedCoordinates(e);this.updateDrag(t.x,t.y)}handlePointerUp(e){if(!this.isEnabled)return;const t=this.getNormalizedCoordinates(e);this.endDrag(t.x,t.y)}handlePointerCancel(e){this.isEnabled&&this.cancelDrag()}handleTouchMove(e){if(!this.isEnabled)return;e.preventDefault();const t=this.getNormalizedCoordinates(e);this.updateDrag(t.x,t.y)}handleTouchEnd(e){if(!this.isEnabled)return;e.preventDefault();const t=this.getNormalizedCoordinates(e);this.endDrag(t.x,t.y)}handleTouchCancel(e){this.isEnabled&&this.cancelDrag()}startDrag(e,t){const n=Date.now();this.dragState={isDragging:!0,startX:e,startY:t,currentX:e,currentY:t,startTime:n,lastMoveTime:n},this.addGlobalListeners()}updateDrag(e,t){const n=Date.now();n-this.lastThrottleTime<this.config.throttleInterval||(this.lastThrottleTime=n,this.dragState.currentX=e,this.dragState.currentY=t,this.dragState.lastMoveTime=n,this.dragState.isDragging&&this.onInput(e,t))}endDrag(e,t){if(this.dragState.isDragging){const n=this.detectSwipe(e,t);n&&n.velocity>this.config.swipeMinVelocity&&this.handleSwipe(n)}this.resetDrag()}cancelDrag(){this.resetDrag()}resetDrag(){this.dragState={isDragging:!1,startX:0,startY:0,currentX:0,currentY:0,startTime:0,lastMoveTime:0},this.removeGlobalListeners()}detectSwipe(e,t){const n=e-this.dragState.startX,o=t-this.dragState.startY,i=Date.now()-this.dragState.startTime;if(i===0)return null;const h=Math.sqrt(n*n+o*o)/i*1e3;let d;const c=Math.abs(n),u=Math.abs(o);return c>u*2?d="horizontal":u>c*2?d="vertical":d="diagonal",{direction:d,velocity:h,deltaX:n,deltaY:o,duration:i}}handleSwipe(e){const t=Math.max(10,Math.floor(e.velocity/100)),n=e.deltaX/t,o=e.deltaY/t;for(let i=0;i<=t;i++){const r=this.dragState.startX+n*i,h=this.dragState.startY+o*i;r>=0&&r<=1&&h>=0&&h<=1&&this.onInput(r,h)}}addGlobalListeners(){(this.globalMoveHandler||this.globalUpHandler)&&this.removeGlobalListeners(),this.globalMoveHandler=e=>{if(!this.isEnabled)return;const t=this.getGlobalNormalizedCoordinates(e);t&&this.updateDrag(t.x,t.y)},this.globalUpHandler=e=>{if(!this.isEnabled)return;const t=this.getGlobalNormalizedCoordinates(e);t?this.endDrag(t.x,t.y):this.resetDrag()},document.addEventListener("mousemove",this.globalMoveHandler),document.addEventListener("mouseup",this.globalUpHandler),document.addEventListener("touchmove",this.globalMoveHandler,{passive:!1}),document.addEventListener("touchend",this.globalUpHandler)}removeGlobalListeners(){this.globalMoveHandler&&(document.removeEventListener("mousemove",this.globalMoveHandler),document.removeEventListener("touchmove",this.globalMoveHandler),this.globalMoveHandler=null),this.globalUpHandler&&(document.removeEventListener("mouseup",this.globalUpHandler),document.removeEventListener("touchend",this.globalUpHandler),this.globalUpHandler=null)}getGlobalNormalizedCoordinates(e){try{let t=null,n=this.container;for(;n&&n.parent;)if(n=n.parent,n&&typeof n=="object"&&"renderer"in n&&n.renderer&&typeof n.renderer=="object"&&"view"in n.renderer){t=n.renderer.view;break}if(!t)return null;const o=t.getBoundingClientRect();let i,r;if(e instanceof MouseEvent)i=e.clientX,r=e.clientY;else{if(e.touches.length===0)return null;i=e.touches[0].clientX,r=e.touches[0].clientY}const h=i-o.left,d=r-o.top,c=this.container.children;if(c.length>0&&c[0]instanceof g){const u=c[0],m=this.container.getBounds(),v=(h-m.x)/this.container.scale.x,b=(d-m.y)/this.container.scale.y;return{x:Math.max(0,Math.min(1,v/u.width)),y:Math.max(0,Math.min(1,b/u.height))}}return null}catch{return null}}destroy(){this.removeGlobalListeners(),this.container.off("pointerdown",this.handlePointerDown.bind(this)),this.container.off("pointermove",this.handlePointerMove.bind(this)),this.container.off("pointerup",this.handlePointerUp.bind(this)),this.container.off("pointercancel",this.handlePointerCancel.bind(this)),this.container.off("touchstart",this.handleTouchStart.bind(this)),this.container.off("touchmove",this.handleTouchMove.bind(this)),this.container.off("touchend",this.handleTouchEnd.bind(this)),this.container.off("touchcancel",this.handleTouchCancel.bind(this)),this.container.eventMode="none"}}class S extends w{constructor(e){super(e);l(this,"inputHandler");l(this,"revealRadius");this.revealRadius=e.revealRadius??3}setupGameSpecific(){try{const e=this.getBlockReveal();if(!e)throw new Error("BlockReveal component not initialized");this.inputHandler=new y({container:e.getContainer(),onInput:this.handleInput.bind(this)})}catch(e){throw console.error("ClickGameController: Failed to setup game specific components:",e),e}}onImagesLoaded(){console.log("Click game: Images loaded, enabling input handler"),this.inputHandler?this.inputHandler.enable():console.warn("Click game: Input handler not initialized, cannot enable")}handleInput(e,t){console.log("Click game controller handling input at:",e,t),this.getBlockReveal().reveal({x:e,y:t,radius:this.revealRadius})}setupAdditionalEventListeners(){}handleGameSpecificKeyDown(e){e.key==="+"||e.key==="="?(this.revealRadius=Math.min(10,this.revealRadius+1),console.log("Reveal radius increased to:",this.revealRadius)):(e.key==="-"||e.key==="_")&&(this.revealRadius=Math.max(1,this.revealRadius-1),console.log("Reveal radius decreased to:",this.revealRadius))}onReset(){console.log("Click game reset")}destroyGameSpecific(){this.inputHandler&&this.inputHandler.destroy()}}window.gameController=null;document.addEventListener("DOMContentLoaded",()=>{const s=new S({containerId:"game-container",backgroundImage:"./assets/images/background.png",foregroundImage:"./assets/images/foreground.png",blockSize:8,gravity:1e3,explosionForce:300,fadeOutDuration:500,revealRadius:3});window.gameController=s;const a=document.getElementById("reset-button");a&&a.addEventListener("click",()=>{s.reset()})});
